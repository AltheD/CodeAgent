<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Project</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f9fafc;
      color: #333;
    }

    .container {
      display: flex;
      margin: 40px auto;
      max-width: 1200px;
      gap: 40px;
    }

    /* Left section */
    .left {
      flex: 2;
      background: #fff;
      border: 1px solid #e5e7eb;
      padding: 24px;
      border-radius: 6px;
    }

    .left h2 {
      font-size: 22px;
      margin-top: 0;
      margin-bottom: 20px;
      color: #1c2330;
    }

    label {
      font-size: 14px;
      font-weight: 500;
      display: block;
      margin-bottom: 6px;
    }

    select, input[type="text"], input[type="file"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 12px;
    }

    a {
      color: #2563eb;
      font-size: 14px;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* Search bar */
    .repo-search {
      display: flex;
      margin: 16px 0;
    }

    .repo-search input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px 0 0 4px;
      outline: none;
      font-size: 14px;
    }

    .repo-search button {
      background: #f3f4f6;
      border: 1px solid #ccc;
      border-left: none;
      padding: 0 12px;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .repo-list {
      margin-top: 16px;
    }

    .repo-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      margin-bottom: 10px;
      background: #fafafa;
      font-size: 14px;
    }

    .repo-item input {
      margin: 0;
    }

    .repo-item i {
      color: #000;
    }

    .continue-btn {
      margin-top: 20px;
      padding: 10px 18px;
      background: #4f46e5;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .continue-btn:hover {
      background: #3730a3;
    }

    /* Right section */
    .right {
      flex: 1;
      background: #fff;
      border: 1px solid #e5e7eb;
      padding: 20px;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.6;
    }

    .right h3 {
      margin-top: 0;
      font-size: 16px;
      margin-bottom: 10px;
    }

    /* Toggle source */
    .choose-source {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .choose-source label {
      font-weight: normal;
      font-size: 14px;
    }

    /* Hide sections */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Local upload styles */
    .analysis-options {
      margin-top: 16px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
    }

    .analysis-options h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      font-weight: bold;
    }

    .analysis-options label {
      font-size: 14px;
      display: block;
      margin-bottom: 8px;
    }

    .note {
      font-size: 13px;
      color: #555;
      margin: 6px 0 12px 0;
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- Left section -->
    <div class="left">
      <h2>Analyze projects</h2>

      <!-- Toggle between GitHub and Computer -->
      <div class="choose-source">
        <label><input type="radio" name="source" value="github" checked> From GitHub</label>
        <label><input type="radio" name="source" value="local"> From this computer</label>
      </div>

      <!-- GitHub section -->
      <div id="githubSection" class="section active">
        <label for="org">Organization</label>
        <select id="org">
          <option>VILLALTA TORUNO JOSUE DANIEL</option>
        </select>
        <a href="#">Import another organization</a>

        <div class="repo-search">
          <input type="text" placeholder="Search for repositories">
          <button><i class="fas fa-search"></i></button>
        </div>

        <label>
          <input type="checkbox"> Select all on this page
        </label>

        <div class="repo-list">
          <div class="repo-item">
            <input type="checkbox">
            <i class="fab fa-github"></i> CodeAgent2
          </div>
          <div class="repo-item">
            <input type="checkbox">
            <i class="fab fa-github"></i> jigsawproject
          </div>
          <div class="repo-item">
            <input type="checkbox">
            <i class="fab fa-github"></i> final
          </div>
        </div>
      </div>

      <!-- Local upload section -->
      <div id="localSection" class="section">
        <label for="projectName">Project Name</label>
        <input type="text" id="projectName" placeholder="Enter project name">

        <div class="analysis-options">
          <h4>分析类型</h4>
          <label><input type="radio" name="analysis" value="single"> 单文件分析</label>
          <label><input type="radio" name="analysis" value="project"> 项目分析</label>
        </div>

        <div id="noteArea" class="note"></div>

        <label for="fileInput">Choose file(s):</label>
        <input type="file" id="fileInput" multiple>

        <div class="analysis-options">
          <h4>检测方式</h4>
          <label><input type="checkbox" name="detect" value="custom"> 自定义静态检测</label>
          <label><input type="checkbox" name="detect" value="pylint"> Pylint检测</label>
          <label><input type="checkbox" name="detect" value="flake8"> Flake8检测</label>
          <label><input type="checkbox" name="detect" value="ai"> AI智能分析</label>
        </div>
      </div>

      <button class="continue-btn" id="continueBtn">Continue</button>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8001/api/v1';
    const githubSection = document.getElementById('githubSection');
    const localSection = document.getElementById('localSection');
    const radios = document.querySelectorAll('input[name="source"]');
    const analysisRadios = document.querySelectorAll('input[name="analysis"]');
    const noteArea = document.getElementById('noteArea');
    const continueBtn = document.getElementById('continueBtn');
    const fileInput = document.getElementById('fileInput');

    radios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === "github") {
          githubSection.classList.add('active');
          localSection.classList.remove('active');
        } else {
          localSection.classList.add('active');
          githubSection.classList.remove('active');
        }
      });
    });

    analysisRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === "single") {
          noteArea.textContent = "支持Python，Java/C/C++，JavaScript，Go等文件，最大10MB";
          fileInput.setAttribute('multiple', '');
        } else if (radio.value === "project") {
          noteArea.textContent = "支持.zip, .tar, .tar.gz等压缩文件，最大100MB";
          fileInput.removeAttribute('multiple');
        }
      });
    });

    // Continue button click handler
    continueBtn.addEventListener('click', async () => {
      const selectedSource = document.querySelector('input[name="source"]:checked').value;
      
      if (selectedSource === 'local') {
        await handleLocalUpload();
      } else {
        alert('GitHub集成功能暂未实现，请选择本地文件上传');
      }
    });

    async function handleLocalUpload() {
      const files = fileInput.files;
      if (files.length === 0) {
        alert('请先选择文件');
        return;
      }

      const analysisType = document.querySelector('input[name="analysis"]:checked').value;
      const detectionOptions = Array.from(document.querySelectorAll('input[name="detect"]:checked')).map(cb => cb.value);
      
      // Show loading state
      continueBtn.disabled = true;
      continueBtn.textContent = '分析中...';

      try {
        const file = files[0]; // For now, only handle single file
        const formData = new FormData();
        formData.append('file', file);
        
        // Build query parameters
        const params = new URLSearchParams({
          enable_static: detectionOptions.includes('custom'),
          enable_pylint: detectionOptions.includes('pylint'),
          enable_flake8: detectionOptions.includes('flake8'),
          enable_ai_analysis: detectionOptions.includes('ai'),
          analysis_type: analysisType === 'single' ? 'file' : 'project'
        });

        const response = await fetch(`${API_BASE_URL}/detection/upload?${params}`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          // Store task info and redirect to main page
          localStorage.setItem('taskId', result.data.task_id);
          localStorage.setItem('fileName', file.name);
          localStorage.setItem('analysisType', analysisType === 'single' ? 'file' : 'project');
          localStorage.setItem('apiBase', API_BASE_URL.replace('/api/v1', ''));
          
          // Redirect to main page
          window.location.href = 'main.html';
        } else {
          throw new Error(result.error || '上传失败');
        }
      } catch (error) {
        alert('上传失败: ' + error.message);
        continueBtn.disabled = false;
        continueBtn.textContent = 'Continue';
      }
    }
  </script>

</body>
</html>
