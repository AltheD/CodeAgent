# 自有项目“拼图大师”游戏缺陷说明

## 缺陷清单

### 配置与调试
- 现状：`socketio.run(..., debug=True)`、`cors_allowed_origins="*"`（风险：生产暴露调试/宽 CORS）
- 建议：按环境开关、收紧 CORS 白名单

### 数据库一致性
- 现状：ORM 与 SQL 不一致（如 `username` 长度 50 vs 16；`rank_records` vs `records`）
- 建议：以迁移为准统一 Schema，补非空/索引

### 资源下载健壮性
- 现状：`requests.get()` 无 timeout/校验和/重试（`download_fonts.py`）
- 建议：增加超时、sha256 校验、有限重试

### 命名与规范
- 现状：ORM 类小写（`class users`），模板名疑似拼写错误（`edditor.html`）
- 建议：PEP8 类名、统一格式化、修正模板名

### 参数/安全
- 现状：直接 `request.args.get`，缺少类型与范围校验；未见 CSRF 保护
- 建议：引入校验（pydantic/flask-wtf），开启 CSRF

---

## CodeAgent 查出缺陷方法

### 工具集
- 质量/规范：pylint、flake8
- 安全：bandit（debug、subprocess、硬编码等）
- 语义：semgrep（Flask 规则：CSRF、XSS、CORS 任意、debug）
- （可选）类型：mypy

### 自定义检测
- Schema 漂移：比对 `extensions.py` vs `table.sql`（字段名/类型/长度/表名）
- 网络健壮性：检测 `requests` 无 timeout/校验和
- CORS/Debug：扫描不安全配置（`debug=True`、`cors_allowed_origins="*"`）


---

## 架构与模式分析

### 架构风格总览
- 分层与模块化：
  - 表示层：`templates/`（HTML）、`static/`（静态资源）
  - 接口层：`views/*.py`（按功能拆分 Blueprint 路由）
  - 应用层：`app.py`（应用组装、注册蓝图与 SocketIO）
  - 领域/数据层：`extensions.py`（SQLAlchemy ORM 模型）
  - 配置层：`config.py`（环境变量加载）
- 运行时特性：
  - 实时通信：Flask-SocketIO（eventlet 异步）
  - 持久化：MySQL（SQLAlchemy ORM）
  - 配置：dotenv 注入环境变量

### 关键组件与职责
- `app.py`：应用工厂/组装（create_app）、注册 Blueprint、启动 SocketIO。
- `views/*.py`：路由与控制器逻辑（认证、图片、AI、PVP、排行、关卡、社交、分享）。
- `extensions.py`：ORM 模型（用户、拼图、成绩、好友、消息、进度）。
- `templates/` 与 `static/`：前端页面与静态资源。
- `config.py`：配置中心（数据库、密钥、端口）。

### 典型交互流程（时序简述）
1) 浏览器请求 → `app.py` 路由分发到对应 `views/*.py` 处理。
2) 业务逻辑读取/写入数据库（`extensions.py` ORM 模型）。
3) 返回模板渲染的页面或 JSON 响应；实时交互走 SocketIO 事件。



